### 1.问题状况

近期收到学校反馈问题，校园卡嵌入i轻工大应用出现访问较慢的现场状况，经过测试复现，发现访问应用确实存在该问题状况。为此公司进行了一系列技术分析和讨论问题解决工作，内容如下。

### 2.耗时分析

我们在手机端APP中进行了多次实测抓包，以下是一次完整的抓包数据主要内容：

![image-20230310134749448](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202303101347647.png)

以上抓包数据格式顺序是从下向上，从左到右，具体分析如下：

- 请求日志时间从17:33:22开始，对应点击校园卡图标的时间

- 点击后，i轻工大APP进行了数据收集和统计，到跳转到B模块的时间是17:33:26，耗时是4秒时

- 身份对接模块完成身份信息互换后跳转到开放平台的时间是17:33:28，耗时是2秒

- 开放平台完成登录获取完接口权限信息后跳转到标准校园卡后台系统的时间是17:33:29，耗时是1秒

- 标准校园卡后台系统查询获取到一卡通用户信息后跳转到标准校园卡前端的时间是17:33:30，耗时1秒

整个请求链路耗时估计大概在5~8秒左右（考虑网络环境等其他因素），其中i轻工大APP在访问应用前进行了数据收集和统计，耗时大概在3~4秒，由于不了解学校APP应用的技术细节，尚不清楚这个耗时的具体原因和影响，需要学校方面协调下相关开发商进行沟通了解具体信息，是否可以进行优化调整。

之后从身份对接模块开始访问完成整个链路的请求耗时同样也是在3~4秒范围，由于涉及到账号转换登录、数据安全、接口安全等相关因素，目前系统流程短时间内无法做较大范围的改动，只能在此基础上进行局部调整，尽量减少大的请求耗时。

### 3.主要优化方案

使用浏览器的session机制，在用户首次访问h5应用后缓存查询数据库的用户信息，将sessionid设置为用户缓存数据查询条件。

在后续的二次请求访问中，如果请求中携带了sessionid，就可以通过该参数查询是否存在用户缓存数据，如果缓存存在，就可以使用缓存数据，立即加载打开页面。

大致的使用流程如下：

![image-20230321145608167](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202303211456850.png)

### 4.上周发现的问题

使用IOS设备可以正常使用session缓存快速打开校园卡应用，Android设备打开校园卡应用和优化前的耗时相当。

下面三次IOS连续访问耗时抓包：

![image-20230321162153712](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202303211621838.png)

IOS设备可以正常请求，增加缓存后，平均耗时在1~2秒左右。

下面是两次Android应用抓包测试记录：

![image-20230321152316376](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202303211523487.png)

上图分为两次连续的请求，左边为第一次访问校园卡应用服务器返回的session信息，这个信息会存入客户端的Cookie中。

中间和右边为第二次请求，其中，右边的请求Cookie中并未携带第一次请求中的session数据，所以请求响应(中间图)又设置了一次session。

根据第二次请求的session状况，可以知道，APP在session访问、存储上设置了限制，导致每次请求都不会携带上一次获取到的session新；具体原因需要协调开发厂商进行分析检查，是否可以更改为session可以正常使用。

### 







