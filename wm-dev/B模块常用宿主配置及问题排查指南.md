B模块是完校用户体系和三方系统用户体系的身份适配平台，主要功能是将三方的userId转换为完美校园的userId，类似于通过三方userId登录完校用户体系下的各个业务系统，主要链路图如下所示。

![image-20230424114920570](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304241149847.png)



### B模块外嵌系统常用术语

**宿主**：完校开放平台业务应用外嵌到的三方系统，可以是APP、h5或者其他客户端。例如：微信公众号、树维系统、迪科系统、钉钉系统、各种银行APP等客户端都是宿主。

**标准对接方案**：B模块的工作是做身份对接转换，所以这里涉及三方系统和B模块的用户信息交换问题，如果三方系统提供了对接方案，那么B模块就需要按照三方的方案去开发代码，主动获取三方的用户信息。

但是如果三方没有提供身份对接方案，那么可以用B模块自己提供的身份对接方案，也就是所谓的标准对接方案，这种情况需要三方系统按照标准方案进行开发，将三方的用户信息主动传给B模块。

**flag参数**：不同的宿主系统提供的对接方案一般是有差异的，因为业务需要，B模块一般会按照三方的对接方案进行开发，主动去获取三方用户信息。由于B模块提供了一个统一入口作为外嵌到各种三方的系统的嵌入地址，所以在嵌入地址中使用了一个flag参数，来区分不同的宿主，并执行对应宿主对接方案的代码。

上面的标准宿主的flag参数为：basicopengroupautobindecard_(自动绑卡)，basicopengroup_（手动绑卡），微信公众号的flag参数为：weixingroup_(手动绑卡)等等。

B模块统一入口可以根据这个flag参数来执行不同宿主的对接代码，通过不同的对接方式获取三方用户信息。

**ecardFunc参数**：这个参数是标卡提供的，默认参数为index，通过配置ecardFunc=不同的关键字可以跳转到标卡的不同页面，对其他外嵌应用无效。上面的index对应标卡的默认首页，trade参数对应标卡教习明细页面，HB_2DCode参数对应标卡的二维码页面。如果需要配置不同的标卡页面，修改ecardFunc参数值即可，这个参数值具体可以咨询标卡的前后端开发人员。

**自动绑卡，手动绑卡**：一般而言，标卡等系统是依赖于一卡通系统的数据的，所以三方账号通过外嵌地址访问这些依赖一卡通数据的应用时，需要关联上一卡通的账号才能获取对应的一卡通用户信息。所以账号关联关系为：

三方用户唯一标识------->完校用户ID------->一卡通学工号

如果三方用户唯一标识刚好就是一卡通学工号，那么B模块在做身份转化时，可以直接使用三方用户唯一标识查询学校一卡通系统是否有这个学工号，如果存在，则直接将完校用户ID关联绑定上这个一卡通学工号，然后直接继续进行业务处理，这个绑卡过程用户是感知不到的。这就是自动绑卡，运维在提供外嵌地址时需要选择自动绑卡的宿主创建宿主应用。

如果三方用户唯一标识不是一卡通学工号，那么就需要用户手动绑定自己的一卡通账号了，开放平台提供了一个绑卡页面，用户在首次外嵌访问时，需要通过这个绑卡页面绑定账号后，才可以进入到后续的业务页面。这就是手动绑卡，如果绑过卡了后续访问就不会看到这个绑卡页面了。



### B模块外嵌地址构成

以一个标准宿主外嵌地址为例：

https://api.17wanxiao.com/b-server/bsacs/light.action?flag=basicopengroupautobindecard_sk_test10&ecardFunc=index&time=1682409255719&userid=2023042554&sign=91FF167277F1D3058F1DF22605038CE0

地址的构成为以下几个部分：

**B模块统一入口地址**：https://api.17wanxiao.com/b-server/bsacs/light.action，大多数宿主外嵌地址入口为/bsacs/light.action。

**flag参数**：flag=basicopengroupautobindecard_sk_test10，宿主对应标识符+下划线_+一个自定义标识符，要求整个flag参数在B模块中是唯一的

**ecardFunc参数**：ecardFunc=index，跳转标卡页面设置参数

**其他参数**：time=1682409255719&userid=2023042554&sign=91FF167277F1D3058F1DF22605038CE0，其他参数都是为了获取三方用户信息用的参数，标准宿主有三个参数，userid是三方用户唯一标识，time和sign参数都是安全验证参数。



### 常用功能介绍

#### bsacs管理>>B模块配置管理

![image-20230426092353137](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304260924280.png)

这个功能是配置【宿主应用】的，宿主应用是学校级的规则配置数据，每条宿主应用可以对应一个或多个学校，并产出一个外嵌地址，三方系统访问该外嵌地址时，只会使用宿主应用配置的规则数据，查询对应学校一卡通的信息，按照配置的规则执行对应的宿主代码。

每个宿主应用独立存在，不会和其他的宿主应用有数据层面上的交集。

下面说明一下常用的菜单栏按钮，以上面的标准宿主外嵌地址为例：

https://api.17wanxiao.com/b-server/bsacs/light.action?flag=basicopengroupautobindecard_sk_test10&ecardFunc=index&time=1682409255719&userid=2023042554&sign=91FF167277F1D3058F1DF22605038CE0

我可以用外嵌地址的flag参数basicopengroupautobindecard_sk_test10为关键字，在B模块配置管理列表中搜索对应的宿主应用数据。

![image-20230426094759725](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304260947805.png)

可以选中该数据点击【编辑】按钮，对宿主应用中的规则进行修改；

![image-20230426100403562](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261004610.png)

或者点击【测试】按钮，测试访问外嵌地址是否正常。这里需要注意，大多数宿主的外嵌地址没有办法直接测试，因为这些三方宿主给外嵌地址传递的用户信息参数多半是加密的，而且只能使用一次，所以没有办法直接测试使用。具体能否测试可以咨询研发人员。

但是对于标准宿主而言，是可以直接测试的，在basicopengroupautobindecard_sk_test10这个应用配置中，学校编码参数customerCode为485，那么就和485编码配置的一卡通系统相对应，我们找一个一卡通账号的学工号，进行如下操作：

![image-20230426101025788](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261010841.png)

通过这种访问可以直接构建一个完整的学工号外嵌地址，访问具体的外嵌应用。

如果有些外嵌应用需要在入口地址增加固定的参数，比如支付缴费的相关应用。我们可以在【应用参数配置】中增加JSON格式的配置参数，这些参数最终会追加到外嵌应用的入口地址上。

![image-20230426103013294](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261030331.png)

如果想查询宿主应用的用户访问日志，可以选中某个宿主应用后，通过菜单的【日志查询】按钮，直接跳转到【系统管理>>宿主访问日志管理】功能下；当然也可以复制宿主应用的标识，手动输入到【宿主访问日志管理】功能中的搜索栏进行搜索：

![image-20230426103447212](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261034273.png)

如果想快捷创建一个宿主应用，可以直接通过菜单栏的【宿主复制】按钮，复制之前已经创建好的宿主应用数据，复制出来的数据会在名称和宿主标识后面追加一个_copy关键字，除此之外的数据则完全和被复制宿主数据相同，然后只需要修改复制数据的名称、标识以及学校等配置数据就可以直接使用了。

![image-20230426103800705](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261038757.png)



#### 系统管理>>宿主配置模板管理

每个宿主应用需要配置哪些规则参数和身份认证参数，这些规则数据是在【宿主配置模板管理】中进行配置的，还以basicopengroupautobindecard_sk_test10宿主应用为例，这是标准宿主，我们可以通过宿主标识搜索到对应宿主模板配置数据：

![image-20230426104657087](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261046131.png)

这个宿主模板配置数据是以JSON格式配置的，宿主应用配置中每一个表单输入框对应模块的一个JSON对象。

![image-20230426104811024](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261048063.png)

比如cookiesecur输入框在宿主应用的位置：

![image-20230426105219460](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261052505.png)

对应上面宿主模块的JSON对象：

    {
        "key": "cookiesecur",
        "value": "true",
        "text": "cookie安全模式",
        "warnText": "https时必须为true"
    },

其中的key是当前配置的唯一标识，这里设置为cookiesecur；value是配置的数值，设置为true代表默认值为true；text为当前配置的项的说明，在表单右边显示；warnText为配置项使用的注意事项，在输入框的下方用红色文字表示。

一般情况下，【宿主配置模板管理】的数据是不需要经常改动的，运维可以自行修改默认值value，文本说明text，和注意事项warnText内容，但是不要修改唯一标识key。如果存在疑问可以咨询研发人员。



#### bsacs管理>>注册账户管理

该功能记录的数据为三方用户唯一标识和完校账号的一对一关联数据，在三方用户首次访问时外嵌地址时会创建一个对应完校账号，然后将完校账号用户ID和三方账号关联起来，在三方用户二次访问时就可以直接查询对应的完校账号进行业务操作了。

![image-20230426111014690](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261110759.png)

上面列表中指的关注的数据有4列：

- 用户账号，这是配置信息和三方用户标识组合的唯一字段，组合格式为【学校编号_三方用户标识\_开放平台ClientId】
- 完美校园用户ID，这是创建完美校园账号用户ID
- 第一次使用的时间，这是三方用户第一次通过外嵌应用访问的时间，也是注册创建完美校园账号的时间
- 最后一次使用时间，这是三方用户最近一次通过外嵌访问应用的时间

在实际使用中可以根据flag宿主标识或者完美校园用户ID进行范围查询或者精确查询。注意该表数据量较大，请谨慎操作。



#### bsacs管理>>宿主客户映射管理

该功能记录了三方学校编码和完校学校编码的一对一映射关系，具体的使用场景为多个学校使用同一个宿主应用的外嵌地址，这种情况下需要三方传递不同学校的编号给外嵌地址，然后B模块根据三方的学校编号查询【宿主客户映射管理】数据中的【完美校园客户编码】，将三方的学校编号转换为完校的学校编号，之后使用完校的学校编号进行业务处理。

![image-20230426113744989](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261137039.png)

列表数据解释：

- 宿主，指定哪个宿主下需要进行学校编码映射，和宿主应用对应
- 平台标记，一般情况需要填写，如果需要填写需要和宿主应用配置项plateform保持相同（建行E码通宿主除外）
- 宿主客户编码，三方学校的编号
- 完美校园客户编码，完美校园体系下学校的编号
- 客户名称，记录当前对应关系属于哪个学校



以建行E码通宿主为例，这种多学校客户的场景需要将customerCode参数设置为空。

![image-20230426113312537](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261133586.png)

然后在【宿主客户映射管理】中新增一条学校编码映射处理即可。



### 常用宿主及配置参数介绍

#### 标准宿主

标准宿主是三方按照B模块的方案进行开发对接，现在有两个标识：basicopengroupautobindecard_(自动绑卡)，basicopengroup_（手动绑卡），一般而言使用自动绑卡的宿主的情况会比较多。判断依据主要是三方传递的用户唯一标识是否是学工号而定，只有满足这个条件才能使用自动绑卡宿主。

宿主应用配置项如下：

![image-20230426133837970](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261338015.png)

![image-20230426133847855](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261338901.png)

![image-20230426133856825](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261338866.png)

一般而言需要配置或修改的参数说明：

- 名称：当前宿主应用的名称
- 宿主：选择宿主应用所归属的宿主，可以通过宿主标识模糊查询
- 标识：一个由英文、数字，下划线等元素自定义组成，需要唯一，不能重复
- campusOpenUrl：开放平台入口地址，一般不需要修改
- client_id：开放平台开放平台应用clientId
- cookiesecur：是否开启cookie安全模式，一般不需要修改
- isForceBindCard：是否开启强制绑卡限制，一般默认为true，如果外嵌应用不依赖一卡通数据，可以不用和一卡通绑卡，将改参数设置为false
- salt：数据加密盐值，安全用途，一般不需要修改
- domain：写入cookie的数据要设置到哪个域名下，一般不需要修改
- group：是否需要开启宿主应用分组，一般不需要修改，如果需要分组请设置为true
- groupflag：在开启宿主应用分组的情况下，这里需要设置一个不重复的唯一值，同一个分组下该配置需要相同
- customerCode：学校编号，需要修改，但是如果存在多学校客户，则不需要设置该配置，并在【宿主客户映射管理】中配置学校映射关系
- pubkey：标准方案中加签用的key，需要提供给三方宿主系统
- hidden：是否显示logo，一般不需要修改
- payType：支付类型，服务商模式，请配置为webchatpay，注意配置该参数后外嵌地址会发生变化，且只能在微信环境打开
- shortFlag：是否开启使用短的宿主标识，一般不需要修改，开启后外嵌地址flag参数会发生变化
- directJump：是否开启不使用light页面js页面进行重定向，开启后B模块身份认证合并为1个请求接口，标准宿主可以设置为默认开启
- cookiesUrl：是否开启使用url传参给开放平台，开启后开放平台优先从url地址中获取参数，一般不需要开启
- fastUrl：快速跳转地址，适配于靳浩东开放的虚拟卡单页面地址，非常规使用方式
- xCode：16位加密参数，适配于靳浩东开放的虚拟卡单页面地址加解密使用，非常规使用方式
- fastParams：是否自定义传递参数，适配于靳浩东开放的虚拟卡单页面地址传参自定义，非常规使用方式
- encryptparam：使用pubkey验签时需要处理的参数，一般不需要修改
- logSync：是否开启宿主的异步日志存储功能，一般为false，不需要开启；开启后通过线程池记录用户日志
- asyncToken：是否开启异步Token功能，开启后可以直接传递开放平台accessToken给标卡，配置标卡外嵌使用，一般为false，不需要开启
- sameOrigin：是否关闭iframe中X-Frame-Options属性同源限制，一般不需要修改
- crossOrigin：是否开启跨域策略，一般不需要修改
- schemeIOS/schemeAndriod：给前端使用的scheme跳转配置，一般不需要修改，需要使用时联系前端人员处理

一般而言，标准宿主配置，只需要修改【名称、宿主、标识、client_id、customerCode】就可以提供外嵌地址使用了，其他配置项使用默认值即可。



#### 微信公众号宿主

使用微信公众号宿主可以将对接过开放平台的应用外嵌到微信环境中，注意外嵌地址有且只能在微信环境访问使用

![image-20230426141803137](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261418198.png)

微信公众号宿主的配置项如上图所示，其他没有展示的部分属于通用配置项，下面说明一下公众号宿主的配置项说明：

- webchatpay：是否开启服务商支付模式，开启后最下方的微信appid和secret需要配置为公司公众号的配置。
- webchatpayThird：是否开启非服务商支付模式，开启后最下方的微信appid和secret需要配置为学校公众号的配置，webchatpay和webchatpayThird参数只能开启一个
- flagToOpen：是否传递宿主应用标识给开放平台，一般不需要开启，该配置项是用于手动绑卡限制卡类型绑卡使用
- appid：微信公众号后台的appid
- appsecret：微信公众号后台的appsecret
- baseurl：公众号回调访问B模块域名配置，一般不需要修改



### CASSSO宿主

CAS单点登录是一种通用且常见的身份认证对接方案，B模块当前使用CAS对接版本为CAS2.0，通常的CAS登录访问流程如下：

1. 三方系统给B模块传递tickiet用户参数
2. B模块使用tickiet参数访问三方系统单点身份系统的认证地址，获取tickiet对应的身份信息
3. 解析tickiet获取的身份信息，选择其中一个用户标识执行后续业务

![image-20230426143545745](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261435804.png)

关键配置参数说明：

- validateTicketUrl：三方系统单点身份系统的认证地址，找三方提供
- userflag：解析tickiet获取的身份信息，选择用于三方用户唯一标识的字段，一般默认为thirdLoginName
- regAndBindCard：是否开启自动绑卡，设置false为手动绑卡（部分宿主是通过开关来控制切换是否自动还是手动绑卡的）

在使用CASSSO宿主需要注意，虽然各公司使用的身份对接方式都是使用的CAS方案，但是各公司的身份用户数据格式是不同的，可能一个公司的用户ID名称为name，而另一个公司的用户ID名称为uid，所以在实际使用过程中需要根据实际的三方身份数据格式来进行配置。

一般而言，可以先将CASSSO宿主应用的外嵌地址提供给三方，让三方系统先进行测试访问，然后在B模块查看该宿主应用的访问日志，找到【B模块使用tickiet参数访问三方系统单点身份系统的认证地址】的日志，示例如下：

![image-20230426145336883](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261453930.png)

将用户信息截图法给三方，确定哪个字段可以用作三方用户唯一标识，然后就可以将参数的key配置到【userflag】配置项中，比如上面的用户信息中，uid和thirdLoginName字段都可以作为三方用户唯一标识。

如果这个三方用户唯一标识是学工号，则可以将【regAndBindCard】设置为true，如果不是，则修改为false。



### 常见问题及问题排查思路

由于外嵌应用一般会涉及的多个项目所以可以通过如下方式来进行问题排查。

- 步骤1，先确认问题发生的现象，时间，影响范围，是否可以稳定重复复现等问题

- 步骤2，根据问题发生的现象来确定问题出在哪个系统上，一般来说只要没有成功的打开外嵌应用本身，不是B模块，就是开放平台中间出现了某些数据异常。
  
  
  比如，如果出现如下样式的的报错，说明B模块在身份认证过程中出现了某些问题，可以进一步查看宿主访问日志来进行问题确认。下图的问题原因是完校后台没有给B模块返回正确的用户数据导致。
  ![image-20230426150612558](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261506614.png)
  
  如果出现如下样式的报错，说明开放平台认证入口出现了某些问题，需要根据访问时间排查开放平台日志信息确定问题原因。
  ![image-20230426152057496](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304261520541.png)

  如果问题样式不属于以上两种，一般来说问题多半来自外嵌应用本身，需要确定外嵌应用是否存在问题。
  
  

#### B模块日志排查方式

在【系统管理>>宿主访问日志管理】功能中可以查看宿主应用对应的用户访问日志，通过宿主应用标识查询可以得到对应的数据信息。

![image-20230427091901010](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304270919073.png)

  如果判断问题出在B模块，可以按照对应问题出现的时间点查询宿主日志来查看是否存在异常问题。

每一次通过B访问外嵌访问应用可以产生一条到多条日志信息，但都是以light日志作为开始，以redirect日志作为结束，如果问题时间点一条日志都没有，则问题多半出在三方宿主本身。

以上面的日志信息截图来看，可以看到两次完整的日志请求数据。

![image-20230427093344417](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304270933469.png)

第一次请求的时间点在2023-04-26 18:17:39，第二次请求发生在2023-04-26 18:18:21，每一次请求的第一条日志在【请求参数】这一列是以light:关键字开头，最后一条日志则以redirect：关键字开头。

在第一条light日志中，我们可以看到三方传递的各种参数信息：

![image-20230427093725660](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304270937706.png)

除了外嵌地址自带的flag参数和ecardFunc参数外，其他参数都是三方传递的，B模块就会根据这些用户相关参数去获取三方的用户唯一标识，如果三方没有传递这些参数信息，就是三方宿主没有配置正确。

第二条日志信息为解析获取三方用户信息的日志：

![image-20230427095613128](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304270956176.png)

从请求参数来看，使用了light三方参数中的param参数，这个参数是加密的，解析的结果在返回值一行中，从其中会选择一个参数作为三方用户唯一标识，这个宿主用户取的是：0000000081E77638BA574AC893A74159305FB97B。

第三条日志为根据完校用户ID查询完校账号的完整数据，这个完校用户ID是从三方用户标识和完校账号的对应关系中获取到的，可以在【bsacs管理>>注册账户管理】查询到这个对应关系：

![image-20230427100815718](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304271008760.png)

下一步是根据完校用户ID请求完校主应用的用户接口获取完整的用户信息，这里我们也可以看到在mobile字段的数据中，也存了三方的用户唯一标识。

![image-20230427095940199](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304270959244.png)

在最后一行的redirect日志中，我们只需要关注B模块最后形成的开放平台认证地址是否正常即可。

![image-20230427101023734](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202304271010792.png)

判断方式是将url字段的地址复制出来，在浏览器打开看看，观察外嵌应用是否正常打开即可，当然这种判断方式可能不太完整，因为部分外嵌应用依赖于宿主环境才能使用，所以有疑问可以咨询相关开发人员即可。





















