#### 现象

在日志文件中频繁出现数据库连接Connection timed out的异常报错(一秒一次)

![image-20220811161445879](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202208111614919.png)

![image-20220811161456626](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202208111614670.png)

#### 排查思路

1. 数据库配置超时相关参数是否合理？是否存在数据库版本和驱动不对应问题？
2. 项目中连接池参数不合理?连接地址不对、不通？缺少某些版本必要参数？

#### 具体排查过程

通过show status like '%thread%'命令来观察，数据库当前的连接数是否存在异常。

![image-20220811161508524](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202208111615553.png)

通过show variables like '%timeout%'命令来观察，数据库超时参数配置是否合理(时间单位：秒)。

![image-20220811161520015](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202208111615052.png)

上述图示可以发现，数据库的活跃线程非常少，而且超时参数也至少有2小时，所以不太可能和配置相关。

通过select version();查询数据版本是5.6.16-log，这个版本一般不需要特别的连接参数配置。

---

#### 代码分析

检查项目所有的数据库连接是否正常，地址是否ping通，端口是否正常，账号是否可以正常访问。

在这个报错的第一行出现了proxoolPool_p的数据库别名的字样，我们可以依据这个线索在排查，通过项目搜索发现这个数据库在一个proxoolPool_push.xml的文件中：

![image-20220811161544452](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202208111615522.png)

并进一步发现这个数据连接的是不通的，所以问题很可能出现在这里。

通过在本地项目中把这个位置的数据库域名地址改成一个不通的地址后也出现了同样的连接超时日志，到这里基本可以确定是这原因导致的了。

#### 进一步分析

在把上面的地址修改正确后，发现Connection timed out的日志依然存在，这就很奇怪了。

我们在项目的日志功能中刚好有一个线程池监控的功能，对于这个数据库连接的监控如下：

![image-20220811161600027](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora-wm/202208111616069.png)

这个数据显示有5个连接是正常的，也就是现在的连接可以正常访问这个数据库了。

但是日志还打印超时日志难道是因为一直有连接在超时吗，但是超市日志还是一秒一秒的打印，也显得过于频繁，不太可能是线程池内的某些连接一直在过期又重新连接。

通过对tomcat的项目检查，发现除了B模块外，还有两个cas项目也放在这个tomcat中，通过进一步寻找，发现这两个项目的日志输出和B模块项目的位置是同一个文件，也就是三个项目的日志混在的同一个文件中.....(大无语)

最后发现有个cas项目的数据库连接也是不通的，更关键的是这个数据库连接的别名也是proxoolPool_p，通过将这个数据库地址修正后发现日志恢复正常。
