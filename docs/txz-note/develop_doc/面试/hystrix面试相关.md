hystrix面试相关

hystrix面试相关

hystrix是对依赖服务调用延迟和调用故障失败进行控制和容错保护的框架，是给系统进行兜底的存在，能在各种缓存雪崩的情况下取系统承受的高并发请求进行限制，保证系统始终存活。
hystrix的主要功能有下面几个：
-资源隔离：保证系统出现问题时，不会有一些逻辑占用完全部的系统资源(比如依赖服务宕机，调用线程都在调用中hang住了，再来新的访问线程同样hang住，最后导致资源耗尽)
-限流：保证系统在高并发请求下，能拒绝大多数的请求，只允许数据库承受范围内的少量请求成功访问
-熔断：当服务完全不可用时，会拒绝所有请求的访问，然后走降级的逻辑
-降级：在服务器故障繁忙时时候可以迅速返回一个指定好逻辑信息，给客户一个有好的提示
-运维监控：当服务出现问题时，可以发送信息通知运维尽快处理

![image-20210805105939374](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora/20210805105948.png)

1.hystrix的资源隔离

hystrix的资源隔离是创建一个Command类继承HystrixCommand<>父类，然后在run()方法中写入隔离逻辑(如服务的调用过程)。者在程序执行时，会创建一个线程池(默认10个线程)来专门执行隔离的代码，当并发超过线程池的上限时，多出来的线程会之间进行熔断。
hystrix的资源隔离策略有两种，一种是线程池，一种是信号量，默认是线程池

![image-20210806143851058](https://alex-img-1253982387.cos.ap-nanjing.myqcloud.com/Typora/20210806143900.png)

2.hystrix的资源隔离和semaphore信号量的区别？和应用场景？

hystrix的资源隔离是创建的线程池，使用其中的线程执行隔离代码；而信号量仅仅是限制并发执行某个逻辑的线程数量，这个线程还是JVM的线程。信号量比线程池的性能会好一些。

应用场景上，线程池适合大多数的场景，如对内外部服务的访问，或超时等问题。而信号量适合内部系统中比较复杂的逻辑，用来限制并发量。

3.hystrix主要执行逻辑

步骤1：创建Command对象
步骤2：执行Command对象
步骤3：查询Command对象是否有本次请求查询的缓存数据，如果有就直接返回缓存给外部线程

步骤4：如果没有，则查询command是否打开了断路器(判断是否熔断降级的对象)，如果断路器打开了那么直接走fallback降级机制

步骤5：继续判断是否，当前Command对象是否已到达并发上限，如果没有空闲资源了，那么也会走fallback降级机制

步骤6：判断Command对象执行逻辑是否超时，如果超时也会走fallback降级机制

步骤7：判断Command对象执行逻辑是否异常报错，如果超时也会走fallback降级机制

步骤8，如果都没有发送正常执行，那么就返回结果给外部线程

4.hystrix的fallback逻辑

在上一个问题中，如果HystrixCommand在执行隔离逻辑时如果出现，隔离资源用完、执行超时、执行报错等问题，都会开始执行降级逻辑，即HystrixCommand.getFallback()，这个方法是隔离资源执行失败后执行的，所有我们可以在这里给外部返回一个默认值，或者从ehcahce、内存缓存中获取一个过期数据(以前从隔离逻辑中返回的数据)

5.hystrix的短路器逻辑

1.在一个滑动窗口时间内(默认10s内)，如果通过断路器的请求数量到到了一个阈值(默认为20)，并且该事件窗口内的请求错误率大于一个百分比(默认为50%)，那么断路器就会改为开启状态。
断路器开启后会将经过的请求全部走fallback降级逻辑。

2.断路器开启一段时间(more是5000ms)后会自动进行一种半开状态(half-open)，半开状态下断路器会放一个请求再去走隔离逻辑，看看能否正常走通，如果可以正常访问了，将会将断路器关闭。


参考：https://blog.csdn.net/manzhizhen/article/details/80296655
全部配置参数：https://cloud.tencent.com/developer/article/1502335